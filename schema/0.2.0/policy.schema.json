{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://github.com/angelgalvisc/clawkernel/blob/main/schema/0.2.0/policy.schema.json",
  "title": "CKP Policy Primitive",
  "description": "Defines behavioral rules: allow/deny/require-approval/audit-only. Firewall-style first-match-wins engine. Section 5.8.",
  "type": "object",
  "properties": {
    "claw": { "$ref": "definitions.schema.json#/$defs/protocolVersion" },
    "kind": { "const": "Policy" },
    "metadata": { "$ref": "definitions.schema.json#/$defs/metadata" },
    "spec": {
      "type": "object",
      "properties": {
        "rules": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "object",
            "properties": {
              "id": { "type": "string", "minLength": 1 },
              "action": {
                "type": "string",
                "enum": ["allow", "deny", "require-approval", "audit-only"]
              },
              "scope": {
                "type": "string",
                "enum": ["tool", "category", "all"]
              },
              "match": {
                "type": "object",
                "properties": {
                  "annotations": { "type": "object" },
                  "category": { "type": "string" }
                },
                "additionalProperties": false
              },
              "reason": { "type": "string" },
              "approval": {
                "type": "object",
                "properties": {
                  "timeout_seconds": { "type": "integer", "minimum": 1 },
                  "default_if_timeout": {
                    "type": "string",
                    "enum": ["deny", "allow"]
                  }
                },
                "additionalProperties": false
              },
              "conditions": {
                "type": "object",
                "properties": {
                  "path_within": { "type": "string" }
                },
                "additionalProperties": true
              },
              "rate_limit": {
                "type": "object",
                "properties": {
                  "cost_per_day_usd": { "type": "number", "minimum": 0 },
                  "tokens_per_day": { "type": "integer", "minimum": 0 }
                },
                "additionalProperties": false
              }
            },
            "required": ["id", "action", "scope"],
            "additionalProperties": false
          },
          "description": "REQUIRED. Ordered list of rules (first match wins)."
        },
        "prompt_injection": {
          "type": "object",
          "properties": {
            "detection": {
              "type": "string",
              "enum": ["pattern", "llm-based", "hybrid", "none"]
            },
            "pattern_engine": { "type": "string" },
            "pattern_count": { "type": "integer", "minimum": 0 },
            "action": {
              "type": "string",
              "enum": ["block-and-log", "warn", "log-only", "ignore"]
            }
          },
          "additionalProperties": false
        },
        "secret_scanning": {
          "type": "object",
          "properties": {
            "enabled": { "type": "boolean" },
            "scope": {
              "type": "string",
              "enum": ["input", "output", "both"]
            },
            "patterns": { "type": "integer", "minimum": 0 },
            "action": {
              "type": "string",
              "enum": ["redact", "block", "warn"]
            }
          },
          "additionalProperties": false
        },
        "input_validation": {
          "type": "object",
          "properties": {
            "max_size_bytes": { "type": "integer", "minimum": 0 },
            "null_byte_detection": { "type": "boolean" },
            "whitespace_analysis": { "type": "boolean" },
            "encoding": { "type": "string" }
          },
          "additionalProperties": false
        },
        "rate_limits": {
          "type": "object",
          "properties": {
            "tool_calls_per_minute": { "type": "integer", "minimum": 0 },
            "tokens_per_hour": { "type": "integer", "minimum": 0 },
            "cost_per_day_usd": { "type": "number", "minimum": 0 }
          },
          "additionalProperties": false
        },
        "audit": {
          "type": "object",
          "properties": {
            "log_inputs": { "type": "boolean" },
            "log_outputs": { "type": "boolean" },
            "log_approvals": { "type": "boolean" },
            "retention": { "$ref": "definitions.schema.json#/$defs/durationString" },
            "destination": {
              "type": "string",
              "enum": ["file", "sqlite", "webhook", "syslog"]
            }
          },
          "additionalProperties": false
        }
      },
      "required": ["rules"],
      "additionalProperties": false
    }
  },
  "required": ["claw", "kind", "metadata", "spec"],
  "additionalProperties": false
}
